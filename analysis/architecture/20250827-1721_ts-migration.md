# TypeScript Migration Analysis — 2025-08-27 17:21

## Executive summary

- Build: TypeScript compiles with 0 errors (strict on). Source emits declarations. Tests type-check under ts-node.
- Scope: src is largely TypeScript; one JS remains: src/types/core.js. Many explicit any remain (≈375 across 29 files).
- Data model: Core types consolidated in src/types/core.ts. JSuites typings provided via src/types/global.d.ts and jsuites-shim.d.ts (duplicated).
- Priority: Eliminate remaining any in hot paths (internal.ts, toolbar.ts, rows.ts, selection.ts, columns.ts), type public API in index.ts/libraryBase.ts, unify JSuites types, remove allowJs.

## Inventory and configuration

- Files: TS in src/utils/_ and core types in src/types/_. One JS file: src/types/core.js. Tests in test/\*.ts only.
- tsconfig.json: strict true, noImplicitAny true, allowJs true, checkJs false, declaration true, skipLibCheck true, baseUrl+paths to src/types (src/tsconfig.json:2–33,34–36).
- tsconfig.test.json: noEmit, includes src and test (tsconfig.test.json:1–9). tsconfig.run.json compiles to dist-test for runtime demos (tsconfig.run.json:1–14).
- Build: webpack + ts-loader targeting ES5 for prod (webpack.config.js:45–58,93–103). Tests via mocha with ts-node/register (package.json:99–102; mocha.config.js:3–23).

## Entry point and API surface

- Entry: src/index.ts exports default jspreadsheet function and attaches helpers and metadata to libraryBase.jspreadsheet (src/index.ts:12–29,31–58,60–113).
- library holder: src/utils/libraryBase.ts defines an any-typed object (src/utils/libraryBase.ts:1–5). Public API should match JSpreadsheet (src/types/core.ts:137–150).

## Core types (data model)

- SpreadsheetOptions, WorksheetInstance, SpreadsheetInstance, SpreadsheetContext, Cell/Row/Header types (src/types/core.ts:3–86,88–110,112–150).
- Global environment and JSuites shims (src/types/global.d.ts:1–35,41–218) and src/types/jsuites-shim.d.ts (duplicated responsibilities).

## Data flow and key mutators

- Creation: Factory.spreadsheet(...) resolves a spreadsheet, pushed to jspreadsheet.spreadsheet, then dispatches onload (src/index.ts:16–22,100–111).
- Destruction: destroy/destroyAll remove DOM and optionally event handlers (src/index.ts:65–84,86–96).
- Navigation/state: keys.ts updates selection indices and triggers lazy loading and selection updates (src/utils/keys.ts:84–120). Reads/writes selectedCell, calls updateSelectionFromCoords().
- Table maintenance: updateTable recalculates spare rows/cols and footer, schedules corner update (src/utils/internal.ts:14–69). Many any in internal routines (parseNumber, createCell, update\* fns).

## Current type-safety state

- tsc errors: 0 (/.agent/errors.json shows current*errors 0). Prior transient parser errors in old data*\* files are gone.
- any usage: ≈375 any across 29 files; hotspots include selection.ts, internal.ts, toolbar.ts, keys.ts, rows.ts (/.agent/errors.json:5–23; .agent/any-types-report.txt).
- Tests: global.d.ts defines root; mocha.config.js sets jsdom and assigns global.root with //@ts-ignore (mocha.config.js:5–14). Consider aligning globals to avoid ts-ignore.

## Risks and gaps

- Public API any: index.ts and libraryBase.ts leak any for options, spreadsheet arrays, helper registry.
- JSuites types duplicated between global.d.ts and jsuites-shim.d.ts; potential drift.
- allowJs true masks stray JS; one JS file remains (src/types/core.js) alongside TS equivalent.
- Many this:any patterns in internal.ts; weak context typing prevents IDE help and refactors.
- Record<string, any> pervasive for dynamic structures (e.g., formula, toolbar items).

## Recommendations (next 1–2 weeks)

1. Public API hardening

- Replace libraryBase any with JSpreadsheet interface. Type jspreadsheet(el, options) → WorksheetInstance[]; type helpers as Record<string, (…)=>…>.
- Type getWorksheetInstanceByName return (WorksheetInstance | Record<string, WorksheetInstance>) precisely.

2. JSuites typings

- Consolidate into a single source of truth (prefer src/types/global.d.ts). Remove duplicate jsuites-shim.d.ts. Ensure mask/calendar/dropdown/contextmenu/toolbar/picker/image signatures cover actual usage in toolbar.ts, internal.ts.

3. Eliminate high-impact any

- Internal: Type updateTable, parseNumber, createCell, updateResult/Scroll, label/getCell APIs using SpreadsheetContext/WorksheetInstance and specific param types (src/utils/internal.ts:14–76,415–1397).
- Toolbar: Introduce ToolbarItem type and strong event handler signatures; replace Record<string, unknown> with discriminated union for items (src/utils/toolbar.ts:12–31,49–60+).
- Keys/Rows/Selection: Ensure this: WorksheetInstance everywhere; finish number|string params cleanup; type guards for DOM (keys.ts already progressing: src/utils/keys.ts:5–35).

4. Config tightening (after above)

- Remove allowJs; delete src/types/core.js. Consider noUncheckedIndexedAccess true once hotspots are typed. Keep skipLibCheck true for now.

5. Tests and CI

- Add type-only tests validating JSpreadsheet surface and core types. Run tsc -p tsconfig.test.json in CI. Add ESLint rule banning explicit any except with @ts-expect-error and ticket.

## Metrics snapshot

- tsc errors: 0
- Files with any: 29; total any ≈375
- Top offenders (approx): selection.ts (~20), internal.ts (~69), toolbar.ts (~90 historic, ~18 now), keys.ts (~16), rows.ts (~15)

## Meeting prompts

- Can we commit to unifying JSuites typings this week?
- Which public API shapes in index.ts need stability guarantees for semver?
- Do we agree to remove allowJs once core.js is deleted?
- Are we comfortable introducing noUncheckedIndexedAccess after hotspot fixes?

## Appendix: references

- tsconfig.json:2–33,34–36; tsconfig.test.json:1–9; tsconfig.run.json:1–14
- src/index.ts:12–29,31–58,60–113; src/utils/libraryBase.ts:1–5
- src/types/core.ts:3–86,88–110,112–150; src/types/global.d.ts:1–35,41–218; src/types/jsuites-shim.d.ts
- src/utils/keys.ts:5–35,84–120; src/utils/internal.ts:14–76
- .agent/errors.json; .agent/any-types-report.txt; .agent/elimination_strategy.md; .agent/TOP10_FILES.md
