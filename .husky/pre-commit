#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Allow commits that only modify whitelisted maintenance files
# (metrics, hooks, plan notes) to avoid blocking bookkeeping commits.
staged=$(git diff --cached --name-only)
# If nothing staged, skip
if [ -z "$staged" ]; then
  exit 0
fi
non_whitelisted_count=$(printf "%s\n" "$staged" | grep -Ev '^(.agent/.*|.husky/.*|plan.json|porting-notes.md)$' | sed '/^$/d' | wc -l)
if [ "$non_whitelisted_count" -eq 0 ]; then
  echo "Only whitelisted files staged (.agent/, .husky/, plan.json, porting-notes.md); skipping any-types enforcement."
  exit 0
fi

# Run any types analysis and fail if any types are found
echo "Running any types analysis..."
node .agent/find-any-types.js

# Check if any types were found (non-zero)
if grep -q "Total any types: [1-9]" .agent/any-types-report.txt; then
    echo "❌ Pre-commit failed: Found any types in the codebase"
    echo "Run 'node .agent/find-any-types.js' to see details"
    exit 1
else
    echo "✅ No any types found - pre-commit passed"
    exit 0
fi
